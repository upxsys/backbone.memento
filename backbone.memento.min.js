// Backbone.Memento v0.4.1a
//
// Copyright (C)2011 Derick Bailey, Muted Solutions, LLC
// Distributed Under MIT Liscene
//
// Documentation and Full License Availabe at:
// http://github.com/derickbailey/backbone.memento

// ----------------------------
// Backbone.Memento
// ----------------------------
define("backbone.memento",["backbone","underscore"],function(t,n){"use strict";var e=function(t,e){this.version="0.4.2",e=n.extend({ignore:[]},e);var i=new r(t,e),s=new o(t,e),a=function(t,n){t&&i.deserialize(t,n)};this.previousState=function(){return s.previous()},this.changes=function(){var t=this.attributes,n=this.previousState(),e=u.map(n,t);return u.clean(e)},this.store=function(){var t=i.serialize();s.push(t)},this.restore=function(t){var n=s.pop();a(n,t)},this.restart=function(t){var n=s.rewind();a(n,t)}},i=function(n){n instanceof t.Model?(this.removeAttr=function(t){n.unset(t)},this.restore=function(t){n.set(t)}):(this.removeAttr=function(t){n.remove(t)},this.restore=function(t){n.reset(t)})},r=function(t,e){function r(t,e){if(t=n.clone(t),e.hasOwnProperty("ignore")&&e.ignore.length>0)for(var i in e.ignore){var r=e.ignore[i];delete t[r]}return t}function o(t,n){var e=[];if(!t||!n)return e;for(var i in n)n.hasOwnProperty(i)&&(t.hasOwnProperty(i)||e.push(i));return e}function u(t,n){for(var e in n){var i=n[e];a.removeAttr(i)}}function s(n,e){var i=r(n,e),s=t.toJSON();s=r(s,e);var c=o(i,s);u(t,c),a.restore(i)}var a=new i(t);this.serialize=function(){var n=t.toJSON();return n=r(n,e)},this.deserialize=function(t,i){i=n.extend({},e,i),s(t,i)}},o=function(t,n){function e(){i=[]}var i;this.push=function(t){i.push(t)},this.previous=function(){return i[i.length-1]},this.pop=function(t){var n=i.pop();return n},this.rewind=function(){var t=i[0];return e(),t},e()},u=function(){return{VALUE_CREATED:"created",VALUE_UPDATED:"updated",VALUE_DELETED:"deleted",VALUE_UNCHANGED:"unchanged",map:function(t,n){if(this.isFunction(t)||this.isFunction(n))throw"Invalid argument. Function given, object expected.";if(this.isValue(t)||this.isValue(n))return{type:this.compareValues(t,n),data:t||n};var e={};for(var i in t)if(!this.isFunction(t[i])){var r=void 0;"undefined"!=typeof n[i]&&(r=n[i]),e[i]=this.map(t[i],r)}for(var i in n)this.isFunction(n[i])||"undefined"!=typeof e[i]||(e[i]=this.map(void 0,n[i]));return e},compareValues:function(t,n){return t===n?this.VALUE_UNCHANGED:"undefined"==typeof t?this.VALUE_CREATED:"undefined"==typeof n?this.VALUE_DELETED:this.VALUE_UPDATED},clean:function(t){var n=this,e={};for(var i in t)void 0!==t[i].data?(t[i].type==n.VALUE_CREATED||t[i].type==n.VALUE_UPDATED)&&(e[i]=t[i].data):e[i]=n.clean(t[i]);return e},isFunction:function(t){return"[object Function]"==={}.toString.apply(t)},isArray:function(t){return"[object Array]"==={}.toString.apply(t)},isObject:function(t){return"[object Object]"==={}.toString.apply(t)},isValue:function(t){return!this.isObject(t)&&!this.isArray(t)}}}();return e});